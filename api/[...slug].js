import C from"express";import ro from"cors";import{createServer as K}from"http";import{randomUUID as v}from"crypto";var P=class{searchHistory;favorites;follows;constructor(){this.searchHistory=new Map,this.favorites=new Map,this.follows=new Map}async getSearchHistory(){return Array.from(this.searchHistory.values()).sort((l,c)=>new Date(c.searchedAt).getTime()-new Date(l.searchedAt).getTime()).slice(0,10)}async addSearchHistory(l){let c=v(),e={...l,id:c,searchedAt:new Date,resultData:l.resultData||null};return this.searchHistory.set(c,e),e}async getFavorites(){return Array.from(this.favorites.values()).sort((l,c)=>new Date(c.addedAt).getTime()-new Date(l.addedAt).getTime())}async addFavorite(l){let c=v(),e={...l,id:c,addedAt:new Date};return this.favorites.set(l.processNumber,e),e}async removeFavorite(l){return this.favorites.delete(l)}async getFavoriteByProcessNumber(l){return this.favorites.get(l)}async getFollows(){return Array.from(this.follows.values()).sort((l,c)=>new Date(c.addedAt).getTime()-new Date(l.addedAt).getTime())}async addFollow(l){let c=v(),e={...l,id:c,addedAt:new Date};return this.follows.set(l.processNumber,e),e}async removeFollow(l){return this.follows.delete(l)}async getFollowByProcessNumber(l){return this.follows.get(l)}},f=new P;import{sql as w}from"drizzle-orm";import{pgTable as j,text as S,varchar as A,timestamp as D,jsonb as T}from"drizzle-orm/pg-core";import{createInsertSchema as x}from"drizzle-zod";import{z as n}from"zod";var k=j("search_history",{id:A("id").primaryKey().default(w`gen_random_uuid()`),processNumber:S("process_number").notNull(),tribunal:S("tribunal").notNull(),searchedAt:D("searched_at").defaultNow().notNull(),resultData:T("result_data")}),q=j("favorites",{id:A("id").primaryKey().default(w`gen_random_uuid()`),processNumber:S("process_number").notNull().unique(),tribunal:S("tribunal").notNull(),addedAt:D("added_at").defaultNow().notNull(),processData:T("process_data").notNull()}),G=j("follows",{id:A("id").primaryKey().default(w`gen_random_uuid()`),processNumber:S("process_number").notNull().unique(),tribunal:S("tribunal").notNull(),addedAt:D("added_at").defaultNow().notNull(),processData:T("process_data").notNull()}),fo=x(k).pick({processNumber:!0,tribunal:!0,resultData:!0}),J=x(q).pick({processNumber:!0,tribunal:!0,processData:!0}),R=x(G).pick({processNumber:!0,tribunal:!0,processData:!0}),z=n.object({processNumber:n.string().min(1,"N\xFAmero do processo \xE9 obrigat\xF3rio"),tribunal:n.string().min(1,"Tribunal \xE9 obrigat\xF3rio")}),H=n.object({tribunal:n.string().min(1,"Tribunal \xE9 obrigat\xF3rio"),processClass:n.string().optional(),judgingBody:n.string().optional(),filingDateFrom:n.string().optional(),filingDateTo:n.string().optional(),searchTerm:n.string().optional()}),N=n.object({tribunal:n.string().min(1,"Tribunal \xE9 obrigat\xF3rio"),processNumbers:n.array(n.string().min(1,"N\xFAmero do processo n\xE3o pode estar vazio")).min(1,"Pelo menos um n\xFAmero de processo \xE9 obrigat\xF3rio").max(1e3,"M\xE1ximo de 1000 processos por busca")}),L=n.object({codigo:n.coerce.number(),valor:n.coerce.number(),nome:n.string(),descricao:n.string()}),U=n.object({codigoOrgao:n.coerce.number(),nomeOrgao:n.string()}),X=n.object({codigo:n.coerce.number().optional(),nome:n.string(),dataHora:n.string(),complemento:n.string().nullable().optional(),complementosTabelados:n.array(L).optional(),orgaoJulgador:U.optional()}),Z=n.object({codigo:n.coerce.number(),nome:n.string()}),$=n.object({numeroProcesso:n.string(),classeProcessual:n.string(),codigoClasseProcessual:n.coerce.number(),sistemaProcessual:n.string(),codigoSistema:n.coerce.number().optional(),formatoProcesso:n.string(),codigoFormato:n.coerce.number().optional(),tribunal:n.string(),ultimaAtualizacao:n.string(),grau:n.string(),dataAjuizamento:n.string(),nivelSigilo:n.coerce.number().optional(),movimentos:n.array(X),orgaoJulgador:n.string(),codigoOrgaoJulgador:n.coerce.number().optional(),codigoMunicipio:n.coerce.number().optional(),assuntos:n.array(Z)}),po=n.object({processNumber:n.string(),result:$.nullable(),error:n.string().nullable(),status:n.enum(["success","error","not_found"])}),_=n.object({format:n.enum(["pdf","csv","json","excel"]),data:n.array($),title:n.string().optional(),includeMovements:n.boolean().default(!0),includeSubjects:n.boolean().default(!0)});import V from"pdfkit";import{stringify as W}from"csv-stringify/sync";import*as b from"xlsx";var M="https://api-publica.datajud.cnj.jus.br/",F=process.env.DATAJUD_API_KEY,B=!F,E={stj:"stj",stf:"stf",tst:"tst",tse:"tse",stm:"stm",trf1:"trf1",trf2:"trf2",trf3:"trf3",trf4:"trf4",trf5:"trf5",trf6:"trf6",tjsp:"tjsp",tjrj:"tjrj",tjmg:"tjmg",tjrs:"tjrs",tjpr:"tjpr",tjsc:"tjsc",tjac:"tjac",tjal:"tjal",tjam:"tjam",tjap:"tjap",tjba:"tjba",tjce:"tjce",tjdft:"tjdft",tjes:"tjes",tjgo:"tjgo",tjma:"tjma",tjms:"tjms",tjmt:"tjmt",tjpa:"tjpa",tjpb:"tjpb",tjpe:"tjpe",tjpi:"tjpi",tjrn:"tjrn",tjro:"tjro",tjrr:"tjrr",tjse:"tjse",tjto:"tjto"};async function O(u,l){if(B)throw new Error("Modo demonstra\xE7\xE3o: Use 'demo-process-123' ou '0000000-00.0000.0.00.0000' para testar");let c=E[u.toLowerCase()];if(!c)throw new Error(`Tribunal n\xE3o suportado: ${u}`);let e=`${M}api_publica_${c}/_search`,o=l.replace(/\D/g,""),r=await fetch(e,{method:"POST",headers:{Authorization:`APIKey ${F}`,"Content-Type":"application/json"},body:JSON.stringify({query:{match:{numeroProcesso:o}},size:1})});if(!r.ok){let a=await r.text();throw new Error(`Erro na API DataJud: ${r.status} - ${a}`)}let s=await r.json();if(!s.hits||!s.hits.hits||s.hits.hits.length===0)throw new Error("Processo n\xE3o encontrado");let t=s.hits.hits[0]._source;return{numeroProcesso:t.numeroProcesso||l,classeProcessual:t.classe?.nome||"N\xE3o informado",codigoClasseProcessual:t.classe?.codigo||0,sistemaProcessual:t.sistema?.nome||t.sistema||"N\xE3o informado",codigoSistema:t.sistema?.codigo,formatoProcesso:t.formato?.nome||t.formato||"eletr\xF4nico",codigoFormato:t.formato?.codigo,tribunal:u.toUpperCase(),ultimaAtualizacao:t.dataHoraUltimaAtualizacao||t.dataUltimaAtualizacao||new Date().toISOString(),grau:t.grau||"N\xE3o informado",dataAjuizamento:t.dataAjuizamento||"N\xE3o informado",nivelSigilo:t.nivelSigilo,movimentos:t.movimentos||[],orgaoJulgador:t.orgaoJulgador?.nome||"N\xE3o informado",codigoOrgaoJulgador:t.orgaoJulgador?.codigo,codigoMunicipio:t.orgaoJulgador?.codigoMunicipioIBGE,assuntos:t.assuntos||[]}}async function Y(u){let{tribunal:l,processClass:c,judgingBody:e,filingDateFrom:o,filingDateTo:r,searchTerm:s}=u;if(B)throw new Error("Modo demonstra\xE7\xE3o: Use 'demo-process-123' ou 'demo' no campo de busca para testar");let t=E[l.toLowerCase()];if(!t)throw new Error(`Tribunal n\xE3o suportado: ${l}`);let a=`${M}api_publica_${t}/_search`,i={bool:{must:[]}};if(c&&i.bool.must.push({match:{"classe.nome":c}}),e&&i.bool.must.push({match:{"orgaoJulgador.nome":e}}),o||r){let p={};o&&(p.gte=o),r&&(p.lte=r),i.bool.must.push({range:{dataAjuizamento:p}})}if(s&&i.bool.must.push({multi_match:{query:s,fields:["classe.nome","orgaoJulgador.nome","assuntos.nome"]}}),i.bool.must.length===0)throw new Error("\xC9 necess\xE1rio especificar pelo menos um filtro de busca");let m=await fetch(a,{method:"POST",headers:{Authorization:`APIKey ${F}`,"Content-Type":"application/json"},body:JSON.stringify({query:i,size:20,sort:[{dataAjuizamento:{order:"desc"}}]})});if(!m.ok){let p=await m.text();throw new Error(`Erro na API DataJud: ${m.status} - ${p}`)}let h=await m.json();if(!h.hits||!h.hits.hits||h.hits.hits.length===0)throw new Error("Nenhum processo encontrado com os filtros especificados");return h.hits.hits.map(p=>{let d=p._source;return{numeroProcesso:d.numeroProcesso||"N\xE3o informado",classeProcessual:d.classe?.nome||"N\xE3o informado",codigoClasseProcessual:d.classe?.codigo||0,sistemaProcessual:d.sistema?.nome||d.sistema||"N\xE3o informado",codigoSistema:d.sistema?.codigo,formatoProcesso:d.formato?.nome||d.formato||"eletr\xF4nico",codigoFormato:d.formato?.codigo,tribunal:l.toUpperCase(),ultimaAtualizacao:d.dataHoraUltimaAtualizacao||d.dataUltimaAtualizacao||new Date().toISOString(),grau:d.grau||"N\xE3o informado",dataAjuizamento:d.dataAjuizamento||"N\xE3o informado",nivelSigilo:d.nivelSigilo,movimentos:d.movimentos||[],orgaoJulgador:d.orgaoJulgador?.nome||"N\xE3o informado",codigoOrgaoJulgador:d.orgaoJulgador?.codigo,codigoMunicipio:d.orgaoJulgador?.codigoMunicipioIBGE,assuntos:d.assuntos||[]}})}async function Q(u,l){if(!E[u.toLowerCase()])throw new Error(`Tribunal n\xE3o suportado: ${u}`);let e=[],o=10;for(let r=0;r<l.length;r+=o){let t=l.slice(r,r+o).map(async i=>{try{if(i==="0000000-00.0000.0.00.0000"||i==="demo-process-123"||i.includes("demo"))return{processNumber:i,result:{numeroProcesso:i,classeProcessual:"A\xE7\xE3o Civil P\xFAblica (Demo)",codigoClasseProcessual:12729,sistemaProcessual:"PJe",codigoSistema:3,formatoProcesso:"eletr\xF4nico",codigoFormato:1,tribunal:u.toUpperCase(),ultimaAtualizacao:new Date().toISOString(),grau:"1\xBA Grau",dataAjuizamento:"2023-01-15T00:00:00Z",nivelSigilo:0,movimentos:[{codigo:26,nome:"Distribui\xE7\xE3o",dataHora:"2023-01-15T10:00:00Z",complemento:"Processo distribu\xEDdo para an\xE1lise",complementosTabelados:[{codigo:2,valor:1,nome:"compet\xEAncia exclusiva",descricao:"tipo_de_distribuicao_redistribuicao"}]}],orgaoJulgador:"1\xAA Vara C\xEDvel",codigoOrgaoJulgador:9700,codigoMunicipio:3550308,assuntos:[{codigo:10518,nome:"Responsabilidade Civil"}]},error:null,status:"success"};let m=await O(u,i);return{processNumber:i,result:m,error:null,status:"success"}}catch(m){return{processNumber:i,result:null,error:m instanceof Error?m.message:"Erro desconhecido",status:m instanceof Error&&m.message==="Processo n\xE3o encontrado"?"not_found":"error"}}}),a=await Promise.all(t);e.push(...a),r+o<l.length&&await new Promise(i=>setTimeout(i,1e3))}return e}function g(u,l="date"){if(!u)return"";if(typeof u=="string"&&["N\xE3o informado","N/A","n/a","n\xE3o dispon\xEDvel"].some(e=>u.toLowerCase()===e.toLowerCase()))return u;try{let e=new Date(u);return isNaN(e.getTime())?typeof u=="string"?u:"":l==="date"?e.toLocaleDateString("pt-BR"):l==="time"?e.toLocaleTimeString("pt-BR"):`${e.toLocaleDateString("pt-BR")} ${e.toLocaleTimeString("pt-BR")}`}catch{return typeof u=="string"?u:""}}async function oo(u,l="Relat\xF3rio de Processos",c=!0,e=!0){return new Promise((o,r)=>{try{let s=new V({margins:{top:50,bottom:50,left:50,right:50},size:"A4",bufferPages:!0,autoFirstPage:!0}),t=[];s.on("data",a=>{t.push(a)}),s.on("end",()=>{try{let a=Buffer.concat(t);console.log(`[PDF] Generated successfully. Size: ${a.length} bytes`),o(a)}catch(a){console.error("[PDF] Error concatenating buffers:",a),r(new Error(`Erro ao criar buffer PDF: ${a instanceof Error?a.message:"desconhecido"}`))}}),s.on("error",a=>{console.error("[PDF] PDFDocument error:",a),r(new Error(`Erro do PDFKit: ${a.message}`))}),s.fontSize(16).font("Helvetica-Bold").text(l,{align:"center"}),s.fontSize(10).text(`Gerado em: ${new Date().toLocaleString("pt-BR")}`,{align:"center"}),s.moveDown(2),u.forEach((a,i)=>{i>0&&s.addPage(),s.fontSize(14).font("Helvetica-Bold").text(`Processo: ${a.numeroProcesso}`),s.moveDown(.5),s.fontSize(10).font("Helvetica"),s.text(`Classe Processual: ${a.classeProcessual}`),s.text(`Tribunal: ${a.tribunal}`),s.text(`\xD3rg\xE3o Julgador: ${a.orgaoJulgador}`),s.text(`Grau: ${a.grau}`),s.text(`Sistema: ${a.sistemaProcessual} (${a.formatoProcesso})`),s.text(`Data de Ajuizamento: ${g(a.dataAjuizamento)}`),s.text(`\xDAltima Atualiza\xE7\xE3o: ${g(a.ultimaAtualizacao)}`),s.moveDown(1),e&&a.assuntos&&a.assuntos.length>0&&(s.fontSize(12).font("Helvetica-Bold").text("Assuntos:"),s.fontSize(10).font("Helvetica"),a.assuntos.forEach(m=>{s.text(`\u2022 ${m.nome} (${m.codigo})`)}),s.moveDown(1)),c&&a.movimentos&&a.movimentos.length>0&&(s.fontSize(12).font("Helvetica-Bold").text("Movimenta\xE7\xF5es:"),s.fontSize(10).font("Helvetica"),a.movimentos.forEach(m=>{let h=g(m.dataHora,"date"),p=g(m.dataHora,"time");s.text(`\u2022 ${h} ${p} - ${m.nome}`),m.complemento&&s.text(`  ${m.complemento}`)}))}),s.end()}catch(s){console.error("[PDF] Error during generation:",s),r(new Error(`Erro ao gerar PDF: ${s instanceof Error?s.message:"desconhecido"}`))}})}function eo(u,l=!0,c=!0){let e=[];return u.forEach(o=>{let r={"N\xFAmero do Processo":o.numeroProcesso,"Classe Processual":o.classeProcessual,"C\xF3digo Classe":o.codigoClasseProcessual,Tribunal:o.tribunal,"\xD3rg\xE3o Julgador":o.orgaoJulgador,Grau:o.grau,Sistema:o.sistemaProcessual,Formato:o.formatoProcesso,"Data de Ajuizamento":g(o.dataAjuizamento),"\xDAltima Atualiza\xE7\xE3o":g(o.ultimaAtualizacao)};if(c&&o.assuntos&&o.assuntos.length>0?(r.Assuntos=o.assuntos.map(s=>s.nome).join("; "),r["C\xF3digos dos Assuntos"]=o.assuntos.map(s=>s.codigo).join("; ")):(r.Assuntos="",r["C\xF3digos dos Assuntos"]=""),l&&o.movimentos&&o.movimentos.length>0){r["Total de Movimenta\xE7\xF5es"]=o.movimentos.length,r["\xDAltimo Andamento"]=o.movimentos[0]?.nome||"",r["Data \xDAltimo Andamento"]=g(o.movimentos[0]?.dataHora),r["Pen\xFAltimo Andamento"]=o.movimentos[1]?.nome||"",r["Data Pen\xFAltimo Andamento"]=g(o.movimentos[1]?.dataHora),r["Antepen\xFAltimo Andamento"]=o.movimentos[2]?.nome||"",r["Data Antepen\xFAltimo Andamento"]=g(o.movimentos[2]?.dataHora);let s=o.movimentos.map((t,a)=>{let i=g(t.dataHora,"date"),m=g(t.dataHora,"time");return`[${a+1}] ${i} ${m} - ${t.nome}${t.complemento?" | "+t.complemento:""}`}).join(" || ");r["Hist\xF3rico Completo de Movimenta\xE7\xF5es"]=s}else r["Total de Movimenta\xE7\xF5es"]=0,r["\xDAltimo Andamento"]="",r["Data \xDAltimo Andamento"]="",r["Pen\xFAltimo Andamento"]="",r["Data Pen\xFAltimo Andamento"]="",r["Antepen\xFAltimo Andamento"]="",r["Data Antepen\xFAltimo Andamento"]="",r["Hist\xF3rico Completo de Movimenta\xE7\xF5es"]="";e.push(r)}),W(e,{header:!0,delimiter:",",quoted:!0,quoted_empty:!0,bom:!0})}function to(u,l=!0,c=!0){let e=u.map(o=>{let r={numeroProcesso:o.numeroProcesso,classeProcessual:o.classeProcessual,tribunal:o.tribunal,orgaoJulgador:o.orgaoJulgador,grau:o.grau,sistemaProcessual:o.sistemaProcessual,formatoProcesso:o.formatoProcesso,dataAjuizamento:o.dataAjuizamento,ultimaAtualizacao:o.ultimaAtualizacao};return c&&(r.assuntos=o.assuntos),l&&(r.movimentos=o.movimentos),r});return JSON.stringify({metadata:{geradoEm:new Date().toISOString(),totalProcessos:u.length,includeMovimentos:l,includeAssuntos:c},processos:e},null,2)}function ao(u,l=!0,c=!0){let e=b.utils.book_new(),o=[];u.forEach(t=>{let a={"N\xFAmero do Processo":t.numeroProcesso,"Classe Processual":t.classeProcessual,"C\xF3digo Classe":t.codigoClasseProcessual,Tribunal:t.tribunal,"\xD3rg\xE3o Julgador":t.orgaoJulgador,"C\xF3digo \xD3rg\xE3o Julgador":t.codigoOrgaoJulgador||"",Grau:t.grau,Sistema:t.sistemaProcessual,"C\xF3digo Sistema":t.codigoSistema||"",Formato:t.formatoProcesso,"C\xF3digo Formato":t.codigoFormato||"","Data de Ajuizamento":g(t.dataAjuizamento),"\xDAltima Atualiza\xE7\xE3o":g(t.ultimaAtualizacao),"N\xEDvel de Sigilo":t.nivelSigilo||"","C\xF3digo Munic\xEDpio":t.codigoMunicipio||""};c&&(a.Assuntos=t.assuntos.map(i=>`${i.nome} (${i.codigo})`).join("; "),a["C\xF3digos Assuntos"]=t.assuntos.map(i=>i.codigo).join("; ")),a["Quantidade de Movimentos"]=t.movimentos.length,l&&t.movimentos.length>0?(a["\xDAltimo Andamento"]=t.movimentos[0]?.nome||"",a["Data \xDAltimo Andamento"]=g(t.movimentos[0]?.dataHora),a["Pen\xFAltimo Andamento"]=t.movimentos[1]?.nome||"",a["Data Pen\xFAltimo Andamento"]=g(t.movimentos[1]?.dataHora),a["Antepen\xFAltimo Andamento"]=t.movimentos[2]?.nome||"",a["Data Antepen\xFAltimo Andamento"]=g(t.movimentos[2]?.dataHora)):(a["\xDAltimo Andamento"]="",a["Data \xDAltimo Andamento"]="",a["Pen\xFAltimo Andamento"]="",a["Data Pen\xFAltimo Andamento"]="",a["Antepen\xFAltimo Andamento"]="",a["Data Antepen\xFAltimo Andamento"]=""),o.push(a)});let r=b.utils.json_to_sheet(o),s=[{wch:25},{wch:30},{wch:15},{wch:15},{wch:30},{wch:20},{wch:10},{wch:15},{wch:15},{wch:15},{wch:15},{wch:18},{wch:18},{wch:15},{wch:15},{wch:50},{wch:30},{wch:22},{wch:50},{wch:18},{wch:50},{wch:18},{wch:50},{wch:18}];if(r["!cols"]=s,b.utils.book_append_sheet(e,r,"Processos"),l){let t=[];if(u.forEach(a=>{a.movimentos.forEach((i,m)=>{let h={"N\xFAmero do Processo":a.numeroProcesso,Sequ\u00EAncia:m+1,Data:g(i.dataHora,"date"),Hora:g(i.dataHora,"time"),"C\xF3digo Movimento":i.codigo||"","Nome do Movimento":i.nome,Complemento:i.complemento||""};i.orgaoJulgador&&(h["\xD3rg\xE3o Julgador Movimento"]=i.orgaoJulgador.nomeOrgao,h["C\xF3digo \xD3rg\xE3o Movimento"]=i.orgaoJulgador.codigoOrgao),i.complementosTabelados&&i.complementosTabelados.length>0&&(h["Complementos Tabelados"]=i.complementosTabelados.map(p=>`${p.nome}: ${p.descricao} (${p.codigo}=${p.valor})`).join("; ")),t.push(h)})}),t.length>0){let a=b.utils.json_to_sheet(t),i=[{wch:25},{wch:10},{wch:12},{wch:10},{wch:18},{wch:40},{wch:50},{wch:30},{wch:20},{wch:60}];a["!cols"]=i,b.utils.book_append_sheet(e,a,"Movimenta\xE7\xF5es")}}if(c){let t=[];if(u.forEach(a=>{a.assuntos.forEach(i=>{t.push({"N\xFAmero do Processo":a.numeroProcesso,"C\xF3digo Assunto":i.codigo,"Nome do Assunto":i.nome})})}),t.length>0){let a=b.utils.json_to_sheet(t),i=[{wch:25},{wch:15},{wch:50}];a["!cols"]=i,b.utils.book_append_sheet(e,a,"Assuntos")}}return b.write(e,{type:"buffer",bookType:"xlsx"})}async function I(u){return u.post("/api/search-process",async(c,e)=>{try{let{processNumber:o,tribunal:r}=z.parse(c.body);if(o==="0000000-00.0000.0.00.0000"||o==="demo-process-123"){let t={numeroProcesso:o,classeProcessual:"A\xE7\xE3o Civil P\xFAblica",codigoClasseProcessual:12729,sistemaProcessual:"PJe",codigoSistema:3,formatoProcesso:"eletr\xF4nico",codigoFormato:1,tribunal:r.toUpperCase(),ultimaAtualizacao:new Date().toISOString(),grau:"1\xBA Grau",dataAjuizamento:"2023-01-15T00:00:00Z",nivelSigilo:0,movimentos:[{codigo:26,nome:"Distribui\xE7\xE3o",dataHora:"2023-01-15T10:00:00Z",complemento:"Processo distribu\xEDdo para an\xE1lise",complementosTabelados:[{codigo:2,valor:1,nome:"compet\xEAncia exclusiva",descricao:"tipo_de_distribuicao_redistribuicao"}]},{codigo:193,nome:"Cita\xE7\xE3o",dataHora:"2023-02-01T14:30:00Z",complemento:"Cita\xE7\xE3o realizada com sucesso"},{codigo:970,nome:"Audi\xEAncia de Concilia\xE7\xE3o",dataHora:"2023-03-15T09:00:00Z",complemento:"Audi\xEAncia realizada - sem acordo"}],orgaoJulgador:"1\xAA Vara C\xEDvel",codigoOrgaoJulgador:9700,codigoMunicipio:3550308,assuntos:[{codigo:10518,nome:"Responsabilidade Civil"},{codigo:10520,nome:"Dano Material"}]};return await f.addSearchHistory({processNumber:o,tribunal:r,resultData:t}),e.json({success:!0,data:t})}let s=await O(r,o);await f.addSearchHistory({processNumber:o,tribunal:r,resultData:s}),e.json({success:!0,data:s})}catch(o){let{processNumber:r,tribunal:s}=c.body;r&&s&&await f.addSearchHistory({processNumber:r,tribunal:s,resultData:null}),console.error("Search process error:",o),e.status(400).json({success:!1,error:o instanceof Error?o.message:"Erro na busca do processo"})}}),u.post("/api/advanced-search",async(c,e)=>{try{let o=H.parse(c.body);if(o.processClass==="Demo"||o.searchTerm==="demo"||o.searchTerm==="demo-process-123"||o.searchTerm==="0000000-00.0000.0.00.0000"){let s=[{numeroProcesso:"1234567-89.2023.8.26.0001",classeProcessual:"A\xE7\xE3o de Cobran\xE7a",codigoClasseProcessual:10234,sistemaProcessual:"PJe",codigoSistema:3,formatoProcesso:"eletr\xF4nico",codigoFormato:1,tribunal:o.tribunal.toUpperCase(),ultimaAtualizacao:new Date().toISOString(),grau:"1\xBA Grau",dataAjuizamento:"2023-01-15T00:00:00Z",nivelSigilo:0,movimentos:[{codigo:26,nome:"Distribui\xE7\xE3o",dataHora:"2023-01-15T10:00:00Z",complemento:"Processo distribu\xEDdo"}],orgaoJulgador:"2\xAA Vara C\xEDvel",codigoOrgaoJulgador:9701,codigoMunicipio:3550308,assuntos:[{codigo:10518,nome:"Cobran\xE7a de D\xEDvida"}]},{numeroProcesso:"2345678-90.2023.8.26.0002",classeProcessual:"A\xE7\xE3o de Cobran\xE7a",codigoClasseProcessual:10234,sistemaProcessual:"PJe",codigoSistema:3,formatoProcesso:"eletr\xF4nico",codigoFormato:1,tribunal:o.tribunal.toUpperCase(),ultimaAtualizacao:new Date().toISOString(),grau:"1\xBA Grau",dataAjuizamento:"2023-02-10T00:00:00Z",nivelSigilo:0,movimentos:[{codigo:26,nome:"Distribui\xE7\xE3o",dataHora:"2023-02-10T09:00:00Z",complemento:"Processo distribu\xEDdo"}],orgaoJulgador:"3\xAA Vara C\xEDvel",codigoOrgaoJulgador:9702,codigoMunicipio:3550308,assuntos:[{codigo:10518,nome:"Cobran\xE7a de D\xEDvida"}]}];for(let t of s)await f.addSearchHistory({processNumber:t.numeroProcesso,tribunal:o.tribunal,resultData:t});return e.json({success:!0,data:s})}let r=await Y(o);r.length>0&&await f.addSearchHistory({processNumber:r[0].numeroProcesso,tribunal:o.tribunal,resultData:r[0]}),e.json({success:!0,data:r})}catch(o){console.error("Advanced search error:",o),e.status(400).json({success:!1,error:o instanceof Error?o.message:"Erro na busca avan\xE7ada"})}}),u.post("/api/bulk-search",async(c,e)=>{try{let{tribunal:o,processNumbers:r}=N.parse(c.body);if(r.some(a=>a.includes("demo")||a==="0000000-00.0000.0.00.0000"||a==="demo-process-123")){let a=r.map((i,m)=>({processNumber:i,result:{numeroProcesso:i,classeProcessual:`A\xE7\xE3o Civil P\xFAblica (Demo ${m+1})`,codigoClasseProcessual:12729,sistemaProcessual:"PJe",codigoSistema:3,formatoProcesso:"eletr\xF4nico",codigoFormato:1,tribunal:o.toUpperCase(),ultimaAtualizacao:new Date().toISOString(),grau:"1\xBA Grau",dataAjuizamento:new Date(2023,0,15+m).toISOString(),nivelSigilo:0,movimentos:[{codigo:26,nome:"Distribui\xE7\xE3o",dataHora:new Date(2023,0,15+m,10,0,0).toISOString(),complemento:`Processo distribu\xEDdo para an\xE1lise - Demo ${m+1}`}],orgaoJulgador:`${m+1}\xAA Vara C\xEDvel`,codigoOrgaoJulgador:9700+m,codigoMunicipio:3550308,assuntos:[{codigo:10518,nome:"Responsabilidade Civil"}]},error:null,status:"success"}));for(let i of a)i.status==="success"&&i.result&&await f.addSearchHistory({processNumber:i.processNumber,tribunal:o,resultData:i.result});return e.json({success:!0,data:a})}let t=await Q(o,r);for(let a of t)a.status==="success"&&a.result&&await f.addSearchHistory({processNumber:a.processNumber,tribunal:o,resultData:a.result});e.json({success:!0,data:t})}catch(o){console.error("Bulk search error:",o),e.status(400).json({success:!1,error:o instanceof Error?o.message:"Erro na busca em lote"})}}),u.post("/api/export",async(c,e)=>{try{console.log("[Export] Request received for format:",c.body.format);let{format:o,data:r,title:s,includeMovements:t,includeSubjects:a}=_.parse(c.body);if(!r||r.length===0)return console.error("[Export] No data provided"),e.status(400).json({success:!1,error:"Nenhum dado fornecido para exporta\xE7\xE3o"});console.log(`[Export] Processing ${r.length} processes for ${o} export`);let i=`processos_${new Date().toISOString().split("T")[0]}`;switch(o){case"pdf":try{console.log("[Export] Starting PDF generation...");let d=await oo(r,s,t,a);console.log(`[Export] PDF generated successfully, size: ${d.length} bytes`),e.setHeader("Content-Type","application/pdf"),e.setHeader("Content-Disposition",`attachment; filename="${i}.pdf"`),e.send(d)}catch(d){throw console.error("[Export] PDF generation failed:",d),d}break;case"csv":console.log("[Export] Starting CSV generation...");let m=eo(r,t,a);console.log("[Export] CSV generated successfully"),e.setHeader("Content-Type","text/csv; charset=utf-8"),e.setHeader("Content-Disposition",`attachment; filename="${i}.csv"`),e.send(m);break;case"excel":console.log("[Export] Starting Excel generation...");let h=ao(r,t,a);console.log(`[Export] Excel generated successfully, size: ${h.length} bytes`),e.setHeader("Content-Type","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"),e.setHeader("Content-Disposition",`attachment; filename="${i}.xlsx"`),e.send(h);break;case"json":console.log("[Export] Starting JSON generation...");let p=to(r,t,a);console.log("[Export] JSON generated successfully"),e.setHeader("Content-Type","application/json; charset=utf-8"),e.setHeader("Content-Disposition",`attachment; filename="${i}.json"`),e.send(p);break;default:return console.error("[Export] Unsupported format:",o),e.status(400).json({success:!1,error:"Formato de exporta\xE7\xE3o n\xE3o suportado"})}}catch(o){console.error("[Export] Error:",o);let r=o instanceof Error?o.message:"Erro na exporta\xE7\xE3o de dados",s=o instanceof Error?o.stack:void 0;console.error("[Export] Stack:",s),e.status(500).json({success:!1,error:r})}}),u.get("/api/search-history",async(c,e)=>{try{let o=await f.getSearchHistory();e.json({success:!0,data:o})}catch(o){console.error("Get search history error:",o),e.status(500).json({success:!1,error:"Erro ao carregar hist\xF3rico"})}}),u.get("/api/favorites",async(c,e)=>{try{let o=await f.getFavorites();e.json({success:!0,data:o})}catch(o){console.error("Get favorites error:",o),e.status(500).json({success:!1,error:"Erro ao carregar favoritos"})}}),u.post("/api/favorites",async(c,e)=>{try{let o=J.parse(c.body);if(await f.getFavoriteByProcessNumber(o.processNumber))return e.status(400).json({success:!1,error:"Processo j\xE1 est\xE1 nos favoritos"});let s=await f.addFavorite(o);e.json({success:!0,data:s})}catch(o){console.error("Add favorite error:",o),e.status(400).json({success:!1,error:o instanceof Error?o.message:"Erro ao adicionar favorito"})}}),u.delete("/api/favorites/:processNumber",async(c,e)=>{try{let{processNumber:o}=c.params;if(!await f.removeFavorite(o))return e.status(404).json({success:!1,error:"Favorito n\xE3o encontrado"});e.json({success:!0,message:"Favorito removido"})}catch(o){console.error("Remove favorite error:",o),e.status(500).json({success:!1,error:"Erro ao remover favorito"})}}),u.get("/api/follows",async(c,e)=>{try{let o=await f.getFollows();e.json({success:!0,data:o})}catch(o){console.error("Get follows error:",o),e.status(500).json({success:!1,error:"Erro ao carregar acompanhamentos"})}}),u.post("/api/follows",async(c,e)=>{try{let o=R.parse(c.body);if(await f.getFollowByProcessNumber(o.processNumber))return e.status(400).json({success:!1,error:"Processo j\xE1 est\xE1 sendo acompanhado"});let s=await f.addFollow(o);e.json({success:!0,data:s})}catch(o){console.error("Add follow error:",o),e.status(400).json({success:!1,error:o instanceof Error?o.message:"Erro ao adicionar acompanhamento"})}}),u.delete("/api/follows/:processNumber",async(c,e)=>{try{let{processNumber:o}=c.params;if(!await f.removeFollow(o))return e.status(404).json({success:!1,error:"Acompanhamento n\xE3o encontrado"});e.json({success:!0,message:"Acompanhamento removido"})}catch(o){console.error("Remove follow error:",o),e.status(500).json({success:!1,error:"Erro ao remover acompanhamento"})}}),u.get("/api/tribunals",(c,e)=>{let o=[{category:"Tribunais Superiores",items:[{value:"stj",label:"STJ - Superior Tribunal de Justi\xE7a"},{value:"stf",label:"STF - Supremo Tribunal Federal"},{value:"tst",label:"TST - Tribunal Superior do Trabalho"},{value:"tse",label:"TSE - Tribunal Superior Eleitoral"},{value:"stm",label:"STM - Superior Tribunal Militar"}]},{category:"Justi\xE7a Federal",items:[{value:"trf1",label:"TRF1 - Tribunal Regional Federal da 1\xAA Regi\xE3o"},{value:"trf2",label:"TRF2 - Tribunal Regional Federal da 2\xAA Regi\xE3o"},{value:"trf3",label:"TRF3 - Tribunal Regional Federal da 3\xAA Regi\xE3o"},{value:"trf4",label:"TRF4 - Tribunal Regional Federal da 4\xAA Regi\xE3o"},{value:"trf5",label:"TRF5 - Tribunal Regional Federal da 5\xAA Regi\xE3o"},{value:"trf6",label:"TRF6 - Tribunal Regional Federal da 6\xAA Regi\xE3o"}]},{category:"Justi\xE7a Estadual",items:[{value:"tjsp",label:"TJSP - Tribunal de Justi\xE7a de S\xE3o Paulo"},{value:"tjrj",label:"TJRJ - Tribunal de Justi\xE7a do Rio de Janeiro"},{value:"tjmg",label:"TJMG - Tribunal de Justi\xE7a de Minas Gerais"},{value:"tjrs",label:"TJRS - Tribunal de Justi\xE7a do Rio Grande do Sul"},{value:"tjpr",label:"TJPR - Tribunal de Justi\xE7a do Paran\xE1"},{value:"tjsc",label:"TJSC - Tribunal de Justi\xE7a de Santa Catarina"},{value:"tjba",label:"TJBA - Tribunal de Justi\xE7a da Bahia"},{value:"tjgo",label:"TJGO - Tribunal de Justi\xE7a de Goi\xE1s"},{value:"tjce",label:"TJCE - Tribunal de Justi\xE7a do Cear\xE1"},{value:"tjpe",label:"TJPE - Tribunal de Justi\xE7a de Pernambuco"}]}];e.json({success:!0,data:o})}),K(u)}var y=null;function so(){return y||(y=C(),y.use(ro({origin:"*",credentials:!0,methods:["GET","POST","PUT","DELETE","PATCH","OPTIONS"],allowedHeaders:["Content-Type","Authorization","X-Requested-With"]})),y.use(C.json({limit:"10mb"})),y.use(C.urlencoded({extended:!1,limit:"10mb"})),I(y)),y}async function no(u,l){return so()(u,l)}var xo={api:{bodyParser:!1}};export{xo as config,no as default};
